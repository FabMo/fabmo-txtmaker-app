<!DOCTYPE html>
<html lang="en"> 
<head>
<meta name="viewport" content="width=device-width, initial-scale=1" charset="utf-8"/>
<link rel="stylesheet" href="css/jquery.mobile-1.4.5.css">


<script src="js/libs/dashboard.js"></script>
<script src="js/jquery-1.11.2.min.js"></script>
<script src="js/control.js"></script>
<script src="js/config.js"></script>
<script src="js/jquery.mobile-1.4.5.js"></script>
<script src="js/processing.min.js"></script>
<script src="js/opentype.min.js"></script>
<script src="js/snap.svg-min.js"></script>
<script src="js/clipper.js"></script>


</head>
<style>

#run{
position: absolute;
left: 0;
top:0;
}

#3D{

position: absolute;
top:0;
left:0;
}

</style>

<body onload="reload();">
<div data-role="page" id="pagezero">
  <div data-role="header">
    <h1>SELECT A FONT</h1>
    <div data-role="navbar">
      <ul>
        <li><a href="#pagezero" class="ui-btn-active ui-state-persist">SETUP</a></li>
        <li><a href="#pageone" onclick="reload();">TEXT</a></li>
<!--        <li><a href="#pagetwo">PREVIEW</a></li> -->
      </ul>
    </div>
  </div>
  <div data-role="main" class="ui-content">
<!--
<textarea id="keyboard" placeholder="Enter Text..."></textarea>

      <label for="text">TEXT:</label>
      <input type="text" name="text" id="text" value="Hello!">
-->
    <form method="post">
      <fieldset class="ui-field-contain">
        <label for="font">FONT</label>
        <select name="font" id="font">
          <option value="ChicagoFLF.ttf">Chicago</option>
          <option value="junegull.ttf" selected>Junegull</option>          
          <option value="newmars.ttf">New Mars</option>
          <option value="Roboto-Black.ttf">Roboto</option>
        </select>
      </fieldset>
    </form>

    <form method="post">
      <fieldset class="ui-field-contain">
        <label for="size">FONT SIZE</label>
        <select name="size" id="size">
          <option value="12.6">1/2"</option>
          <option value="25.4">1"</option>
          <option value="50.8">2"</option>
          <option value="76.2">3"</option>
          <option value="101.6" selected>4"</option>
          <option value="127">5"</option>
          <option value="152.4">6"</option> 


        </select>
      </fieldset>
    </form>

    <form method="post">
      <fieldset class="ui-field-contain">
        <label for="materail">MATERIAL TYPE</label>
        <select name="material" id="material">
          <option value="plywood" selected>PLYWOOD</option>
          <option value="wax">WAX</option>
          <option value="hdpe">HDPE</option>
          <option value="foam">FOAM</option>
          <option value="pcb">PCB</option>
          <option value="aluminum">ALUMINUM</option>
        </select>
      </fieldset>
    </form>

    <form method="post">
      <fieldset class="ui-field-contain">
        <label for="material">MATERIAL THICKNESS</label>
        <select name="thickness" id="thickness">
          <option value="0.073">1/16"</option>
          <option value="0.135" selected>1/8"</option>
          <option value="0.26">1/4"</option>
          <option value="0.51">1/2"</option>
        </select>
      </fieldset>
    </form>

    <form method="post">
      <fieldset class="ui-field-contain">
        <label for="day">CUTTING TOOL</label>
        <select name="tool" id="tool">
          <option value="0.125" selected>1/8" ENDMILL</option>
          <option value="0.25">1/4" ENDMILL</option>
        </select>
      </fieldset>
    </form>
</div>
  <div data-role="footer" style="text-align:center;">
    <a href="#pageone" onclick="reload();" class="ui-btn ui-corner-all ui-shadow ui-icon-carat-r ui-btn-icon-right">TEXT</a>
  </div>
</div> 

<div data-role="page" id="pageone">
  <div data-role="header">
    <h1>PRESS A KEY</h1>
    <div data-role="navbar">
      <ul>
        <li><a href="#pagezero">SETUP</a></li>
        <li><a href="#pageone" onclick="reload();" class="ui-btn-active ui-state-persist">TEXT</a></li>
<!--        <li><a href="#pagetwo">PREVIEW</a></li> -->
      </ul>
    </div>
  </div>
  <div data-role="main" class="ui-content">
    <canvas id="2D" tabindex="1"> </canvas>
   <!--
    <textarea id="keyboard" placeholder="Enter Text..."style="display: none;" ></textarea>
   -->
    <input type="text" id="keyboard" value="Hello!" style="display: none;"></input>
  </div>
  <div data-role="footer" style="text-align:center;">
<!--
    <textarea id="keyboard" placeholder="Enter Text..." style="display: none; visibility: hidden;" ></textarea>
-->

<a href="#pagetwo" class="ui-btn ui-corner-all ui-shadow ui-icon-eye ui-btn-icon-left">FULLSCREEN</a>

<a href="#pagetwo" id="keybutton" class="ui-btn ui-corner-all ui-shadow ui-icon-edit ui-btn-icon-left">KEYBOARD</a>

    <a href="#pagetwo" class="ui-btn ui-corner-all ui-shadow ui-icon-action ui-btn-icon-right" onclick="make();">SUBMIT JOB</a>

  </div>
</div> 

<!--

<div data-role="page" id="pagetwo">
  <div data-role="header">
    <h1>SUBMIT JOB</h1>
    <div data-role="navbar">
      <ul>
        <li><a href="#pagezero">SETUP</a></li>
        <li><a href="#pageone" onclick="reload();">TEXT</a></li>
        <li><a href="#pagetwo" class="ui-btn-active ui-state-persist">PREVIEW</a></li>
      </ul>
    </div>
  </div>
  <div data-role="main" class="ui-content">
   <canvas id="3D">  </canvas>
     </div>
      <div data-role="footer" style="text-align:center;">
    <a href="#pagetwo" class="ui-btn ui-corner-all ui-shadow ui-icon-action ui-btn-icon-left" onclick="make();">SUBMIT JOB</a>
  </div>
</div> 
-->





<script type="application/processing" data-processing-target="2D">



//font = loadFont("FFScala.ttf"); 

int verts = 100;
int radius = 40;
int sf2 = ($(window).innerHeight()-275)/document.getElementById("size").value;
int sfx = 1;
int x = 0;
int y = 0;

void setup(){
   size($(window).innerWidth()-30,$(window).innerHeight()-180);
   background(235);
   noFill();
   smooth();  
   frameRate(4);
   strokeCap(ROUND);
   strokeWeight(1);
   textFont(createFont("Arial",4));
   
}

void draw(){
   background(235);
   document.getElementById("2D").focus();
   sf2 = ($(window).innerHeight()-275)/document.getElementById("size").value;
   



translate(130,height-height*0.3);
scale(sf2,sf2);



stroke(0,100,0,100);
strokeWeight(1/sf2);

//ellipse(xmin,ymin,1,1);
//ellipse(xmax,ymax,1,1);
line(xmin-5,ymax,xmin-8,ymax);
line(xmin-8,ymin,xmin-8,ymax);
line(xmin-5,ymin,xmin-8,ymin);

stroke(200,0,0,100);
line(xmin,ymax+8,xmin,ymax+5);
line(xmin,ymax+8,xmax,ymax+8);
line(xmax,ymax+8,xmax,ymax+5);

fill(180,0,0,100);
text(nf((xmax-xmin)/25.4,1,2) + " ", xmax/2-2, ymax+12);
noFill();

fill(0,100,0,100);
text(nf((abs(ymin)+ymax)/25.4,1,2) + " ", xmin-16, ymin/2+2);
noFill();

strokeWeight(1/sf2*2);



for(i=0;i<dots.length;i++){


   stroke(0);

   strokeWeight(2/sf2);

   beginShape();

   for(j=0;j<dots[i].length;j++){
         if(j==0){
            stroke(255,0,0);
//            ellipse(dots[i][j][0],dots[i][j][1],0.5,0.5);
            vertex(dots[i][j][0],dots[i][j][1]);
         }
         else if(j==1){
            stroke(0,0,255);
//            ellipse(dots[i][j][0],dots[i][j][1],0.5,0.5);
            vertex(dots[i][j][0],dots[i][j][1]);
         }
         else if(j!=dots[i].length-1){
            stroke(0);
//            ellipse(dots[i][j][0],dots[i][j][1],sf2*0.1,sf2*0.1);
            vertex(dots[i][j][0],dots[i][j][1]);
         }
         else{
           vertex(dots[i][j][0],dots[i][j][1]);
         }         
      
   }

endShape();

}


stroke(200,0,200);


for(i=0;i<offsetted_paths.length;i++){

   beginShape();
      for(j=0;j<offsetted_paths[i].length;j++){
         vertex(offsetted_paths[i][j].X/100,offsetted_paths[i][j].Y/100);
      }
   endShape();

sf2 = ($(window).innerHeight()-275)/document.getElementById("size").value;

}


}



void keyPressed() {


   if (key == BACKSPACE){



   }


txt = String.fromCharCode(key);


loadtxt();

}


void resizeSketch(){
   size($(window).innerWidth()-30,$(window).innerHeight()-180);
   sf2 = ($(window).innerHeight()-275)/document.getElementById("size").value;


}

$(window).resize(function() {	
   resizeSketch();
});


</script>

<script>

var g = "";
var gcode = [];                      
var paths = [];
var shapes = [];
var fontFileName;
var points = [];
var count = [];
var svg = [];
var test = [];
var test2 = [];
var len = [];
var points = [];
var txt = "?";
var xy = [];
var xy_offset = [];
//var keyz;
var oset = [[0,1]];
var dots = [];
var tool_diameter;

var curve = "";
var curve_length;
var offsetted_paths = [];

var x = [];
var y = [];
var xmin;
var xmax;
var ymin;
var ymax;


function reload(){

//   var txt = document.getElementById("text").value;
//alert(document.getElementById("font").value);   

   points = [];
   count = [];
   shapes = [];
   test = [];
   test2 = [];
   points = [];
   path = "";
   paths = [];
   xy = [];
   xy_offset = [];
   dots = [];
   svg = [];
   offsetted_paths = [];
   
   loadfont();
   loadtxt();

}

function loadfont() {
   fontFileName = 'fonts/' + document.getElementById("font").value;
//   txt = txt;
}


function loadtxt() {
   opentype.load(fontFileName, function(err, font) 
   {

   if (err) {
   alert('Font could not be loaded: ' + err);
   } 
      else {
      onFontLoaded(font);
      }
});

}

function onFontLoaded(font) {

//var txt = document.getElementById("text").value;
var path = font.getPath(txt, 0, 0, document.getElementById("size").value);


for(i=0;i<path.commands.length;i++){
   if(path.commands[i].type=="M"){
   count.push(i);
   }
}

for(i=0;i<count.length;i++){

   if(i==0){
      paths.push([path.commands.slice(0,count[i+1])]);
   }
   else if(i==count.length-1){
      paths.push([path.commands.slice(count[i])]);
   }
   else{
      paths.push([path.commands.slice(count[i],count[i+1])]);
   }

}

for(i=0;i<paths.length;i++){
   shapes.push(paths[i]);
}

for(i=0;i<shapes.length;i++){
test.push({commands: shapes[i][0], fill: "black", stroke: null, strokeWidth: 1});
}

test2 = [];
dots = [];
var lines;


for(i=0;i<test.length;i++){

dots.push([]);

    for(i2=0;i2<test[i].commands.length;i2++){
  
      test2 += test[i].commands[i2].type + " ";
   
       if((test[i].commands[i2].type=="L") || (test[i].commands[i2].type=="M")){
          test2 += test[i].commands[i2].x + " ";
          test2 += test[i].commands[i2].y + " ";
          dots[i].push([test[i].commands[i2].x,test[i].commands[i2].y]);
                
       }  

      if(test[i].commands[i2].type=="Q"){
         test2 += test[i].commands[i2].x1 + " "; 
         test2 += test[i].commands[i2].y1 + " ";
         test2 += test[i].commands[i2].x + " "; 
         test2 += test[i].commands[i2].y + " ";

//            dots.push([test[i].commands[i2].x1,test[i].commands[i2].y1]);
//            dots[i].push([test[i].commands[i2].x,test[i].commands[i2].y]);
         
         curve += "M ";
         curve += test[i].commands[i2-1].x + " ";
         curve += test[i].commands[i2-1].y + " ";

         curve += test[i].commands[i2].type + " ";
         curve += test[i].commands[i2].x1 + " "; 
         curve += test[i].commands[i2].y1 + " ";
         curve += test[i].commands[i2].x + " "; 
         curve += test[i].commands[i2].y + " ";

//         console.log(curve);
         curve_length = parseFloat(Snap.path.getTotalLength(curve).toFixed(0));
//         console.log(curve_length);

if(curve_length>1){
         
         for(j=1;j<curve_length;j=j+1){
            dots[i].push([Snap.path.getPointAtLength(curve, j).x,Snap.path.getPointAtLength(curve, j).y]);
//            console.log(dots);
         }

}

            dots[i].push([test[i].commands[i2].x,test[i].commands[i2].y]);

         curve = "";
         curve_length = 0;                 
      } 
   }
svg.push(test2);

test2 = "";
}


var area = [];
var sum = 0;
var minx = [];
var miny = [];
var low = [];


xy = [];


x = [];
y = [];


for(i=0;i<dots.length;i++){

points.push([]);

   for(j=0;j<dots[i].length;j++){

      points[i].push({X:dots[i][j][0],Y:dots[i][j][1]}); 
      x.push(dots[i][j][0]);
      y.push(dots[i][j][1]);
   }

}

//console.log(dots);

if(dots.length<1){
   xmin = 0;
   xmax = 0;
   ymin = 0;
   ymax = 0;
}
else{
xmin = (Math.min.apply(Math, x));
xmax = (Math.max.apply(Math, x));
ymin = (Math.min.apply(Math, y));
ymax = (Math.max.apply(Math, y));
}




//console.log(ymin/25.4);
//console.log(ymax/25.4);
//console.log(xmin/25.4);
//console.log(xmax/25.4-xmin/25.4);


tool_diameter=document.getElementById("tool").value;

var scale = 100;

ClipperLib.JS.ScaleUpPaths(points, scale);
var co = new ClipperLib.ClipperOffset(2, 0.25);
co.AddPaths(points, ClipperLib.JoinType.jtMiter, ClipperLib.EndType.etClosedPolygon);
offsetted_paths = new ClipperLib.Paths();
co.Execute(offsetted_paths, (tool_diameter/2*25.4) * scale);

for(i=0;i<offsetted_paths.length;i++){
   offsetted_paths[i].push(offsetted_paths[i][0]);
}

//console.log(offsetted_paths);

xy_offset = [];

   points = [];
   count = [];
   shapes = [];
   test = [];
   test2 = [];
   path = " ";
   paths = [];
   shape = [];
   len = [];
   svg = [];

}


function make(){

g="";

//header
g+="g21\n";
g+="g0z5\n";
g+="m4\n";
g+="g4p2";


//console.log(offsetted_paths);
for(i=offsetted_paths.length-1;i>=0;i--){   

//   gcode.push([]);

   for(j=0;j<offsetted_paths[i].length;j++){

      if(j==0){
         g +="g0z5\n";
         g += "g0x" + offsetted_paths[i][j].X/100 + "y" + (ymax-offsetted_paths[i][j].Y/100) + '\n';
         g +="g1z-" + document.getElementById("thickness").value + "f500\n";
         g +="g1f1500\n";         

      }
      
      else{
         g += "g1x" + offsetted_paths[i][j].X/100 + "y" + (ymax-offsetted_paths[i][j].Y/100) + '\n';
      }
   }

   g +="g0z5\n";

}

g+="m5\n";
g+="m30\n";


//console.log(offsetted_paths);
//console.log(gcode);
//console.log(g);

fabmoDashboard.submitJob(g, {filename : txt+'.g', name : "TEXT: " + txt, description : "FONT: " + document.getElementById("font").value});

}



$( "#keybutton" ).click(function() {

txt = window.prompt("?");
loadtxt();

  
});

</script>


</body>
</html>

