<!doctype html>
<html>
	<head>
		<title>TxtMaker</title>
		<link rel="stylesheet" type="text/css" href="css/style.css">
      <link rel='stylesheet' href='css/nprogress.css'/>
	</head>

<body onload="loadfont(); loadtxt();">
	
      <script type="text/javascript" src="js/opentype.min.js"></script>
      <script type="text/javascript" src="js/processing.min.js"></script>
      <script type="text/javascript" src="js/dat.gui.min.js"></script>
      <script type="text/javascript" src="js/snap.svg-min.js"></script>
      <script type="text/javascript" src="js/nprogress.js"></script>
      <script type="text/javascript" src="js/dashboard.js"></script>
      <script type="text/javascript" src="js/jquery-1.11.2.min.js"></script>

<control>
<input type="text" name="txt" id="textbox" value="Txt">
<button onclick="reload();">DRAW</button>
<input type="file" id="file">LOAD FONT (TTF)</input>

</control>

<script type="text/javascript">
var font;
var click = 0;

function onReadFile(evt) {
    NProgress.start();
    var f = evt.target.files[0]; 

    if (f) {

      var r = new FileReader();
      r.onload = function(e) { 
	     var contents = e.target.result;
        
        font = opentype.parse(e.target.result);
        alert( "RELOAD TEXT");
        onFontLoaded(font);

      }

      r.readAsText(f);
    } else { 
      alert("Failed to load file");
    }
  r.readAsArrayBuffer(f);
click=1;
font=font;
}

document.getElementById('file').addEventListener('change', onReadFile, false);

function reload(){


alert("RELOAD TEXT");
if(click == 0){
loadtxt();
}
else{
onFontLoaded(font);
}

}

</script>

<script>

//dat gui
var obj = {
txtheight : 50,
gcode : false,
feedrate : 800,
plungerate : 300,
cd : -2,
texty : 0,
xgrid : 10,
fontheight : 50,
td : 1.6,

}

var gcode = [" "];

var w = 200;
var h = 150;

var sf = window.innerHeight/h;

w = w*sf;
h = h*sf-30;

var obj2 = {make:function() {
obj.gcode=true;

}}

var gui1 = new dat.GUI();

var f1 = gui1.addFolder('setup');
f1.add(obj, 'feedrate', 1, 2000).step(10).name('feedrate');
f1.add(obj, 'plungerate', 1, 1000).step(10).name('plungerate');
f1.add(obj, 'cd', -6, 0).name('cut depth');
//f1.add(obj, 'texty', 0, 200).listen().name('Y position');
f1.add(obj, 'xgrid', 5, 100).step(5).name('grid spacing');
f1.add(obj, 'txtheight', 1, 250).step(1).listen().name('text size');
var height = f1.add(obj, 'fontheight', 1, 250).step(1).name('font size');



gui1.add(obj2, 'make').name('MAKE TEXT');

f1.open();

height.onFinishChange(function(value) {


reload();

});

var x = [""];
var y = [""];
var xc = [""];
var yc = [""];
var g = [" "];

var fontFileName;

function loadfont() {
fontFileName = 'fonts/Roboto-Black.ttf';
}

function loadtxt() {
NProgress.start();
opentype.load(fontFileName, function(err, font) 
{
if (err) 
{
alert('Font could not be loaded: ' + err);
} 
else  
{
onFontLoaded(font);
}
});

}

function onFontLoaded(font) {

NProgress.set(0.5)
var txt = document.getElementById("textbox").value;
var path = font.getPath(txt, 0, h, sf*obj.fontheight);
var svg = path.toSVG(2);
var len = Snap.path.getTotalLength(svg).toFixed(0);

for (i2 = 0; i2 <= len; i2=i2+1) {

var one = Snap.path.getPointAtLength(svg, i2);
//var circle = paper.circle(one.x, one.y, 1);
x.splice(i2,0,one.x.toFixed(3));
y.splice(i2,0,one.y.toFixed(3));

}


NProgress.done();

xc = x;
yc = y;
//console.log(x);
//console.log(y);
x = []; 
y = [];
svg = [];
yc[yc.length-1]="end";      

}

</script>

<script type="application/processing" data-processing-target="mycanvas">

int xlength = 200;
int ylength = y.length;

//todo
//tabs and multipass
float x0;
float y0;

int mx=10*sf;
int my=10*sf;
int ymax;
int ymin;

int xo=0;
int yo=0;

int pn=1;//pass no

int texth;

int [] yscale;

void setup()
{

size(w,h);
background(0,130,0);
strokeJoin(ROUND);
 
}

void draw()
{  
background(0,130,0);

noFill();

ymin = min(yc);
texth=int(h-ymin);
obj.txtheight=(texth/sf)+1.6;

stroke(0,135,235);
strokeWeight(4);
rect((10*sf)-1,(h-10*sf)+1,150*sf,0-120*sf);

stroke(170);
strokeWeight(1);
line(0,h,w,h);
line(0,h,0,0);

fill(255,255,0);
ellipse(10*sf, h-10*sf, 2*sf, 2*sf);
noFill();

for(i=1; i<=w/obj.xgrid*sf; i++){
line(0,h-i*obj.xgrid*sf,w,h-i*obj.xgrid*sf);
}

for(i=1; i<=h/obj.xgrid*sf; i++){
line(i*obj.xgrid*sf,h,i*obj.xgrid*sf,0);
}

//translate(mx, 0-my+obj.texth*sf);

translate(mx, 0-my-sf);

stroke(255,0,0,220);
strokeWeight(1);

line(0,h+sf,20,h+sf);
line(0,h-(texth+sf),20,h-(texth+sf));
line(0,h+sf,0,h-(texth+sf));

stroke(255,200);
strokeWeight(1.6*sf);

beginShape();
for (int i = 0; i < xc.length-1; i = i+1) {

if((abs(xc[i]-xc[i-1]) > 3) || (abs(yc[i]-yc[i-1]) > 3)){

endShape(CLOSE);
beginShape();

}

else{
vertex(xc[i], yc[i]);
}

}
endShape(CLOSE);



if(obj.gcode==true){
makegcode();


obj.gcode=false;
}



}

void makegcode(){

header();

for (int i = 0; i < xc.length-1; i = i+1) {

if(i==0){
gcode = splice(gcode,"g0x" + nf((xc[i]/sf)+xo, 1, 2) + "y" + nf(((h+obj.texty*sf-yc[i])/sf)+yo, 1, 2) ,1);
gcode = splice(gcode,"g1z" + obj.cd + "f" + obj.plungerate,1);
gcode = splice(gcode,"f" + obj.feedrate,1);
x0 = nf((xc[i]/sf)+xo,1,2);
y0 = nf(((h+obj.texty*sf-yc[i])/sf)+yo,1,2);
}

//move to next path
else if((abs(xc[i]-xc[i-1]) > 3) || (abs(yc[i]-yc[i-1]) > 3)){


if (abs(obj.pd)>(obj.td*pn)){
//gcode = splice(gcode,"g1x" + x0 + "y" + y0 ,1);
//gcode = splice(gcode,"g1z" + 0-(obj.td*pn) + "f" + obj.plungerate,1);
//gcode = splice(gcode,"f" + obj.feedrate,1);
}

else{
gcode = splice(gcode,"g1x" + x0 + "y" + y0 ,1);
gcode = splice(gcode,"g0z4",1);
gcode = splice(gcode,"g0x" + nf((xc[i]/sf)+xo, 1, 2) + "y" + nf(((h+obj.texty*sf-yc[i])/sf)+yo, 1, 2) ,1);
gcode = splice(gcode,"g1z" + obj.cd + "f" + obj.plungerate,1);
gcode = splice(gcode,"f" + obj.feedrate,1);
x0 = nf((xc[i]/sf)+xo,1,2);
y0 = nf(((h+obj.texty*sf-yc[i])/sf)+yo,1,2);
}

}//

else{
gcode = splice(gcode,"g1x" + nf((xc[i]/sf)+xo, 1, 2) + "y" + nf(((h+obj.texty*sf-yc[i])/sf)+yo, 1, 2) ,1);
}

}


footer();

String[] sa = reverse(gcode);
g = join(sa, "\n");

fabmoDashboard.submitJob(g, {filename : 'TxtMaker.g', name : 'TxtMaker', description : 'Generated by TxtMaker'});


gcode=[];
g=[];
s=[];

}

void mouseClicked() {

mx=mouseX;
my=h-mouseY;

xo=int((mx/sf)-(10));
yo=int((my/sf)-(10));
//println(xo);
//println(yo);


}




void header(){

//gcode header
//gcode = splice(gcode,"(units=mm/min)",1);
gcode = splice(gcode," ",1);//inch g20
gcode = splice(gcode,"g21",1);//inch g20
gcode = splice(gcode,"g0z4",1); //go safe height
gcode = splice(gcode,"g0x0y0",1); //go home
gcode = splice(gcode,"m4",1);//turn on router

}

void footer()
{
gcode = splice(gcode,"g1x" + x0 + "y" + y0 ,1);
gcode = splice(gcode,"g0z4",1);
gcode = splice(gcode,"m5",1);
gcode = splice(gcode,"g0x0y0",1);
gcode = splice(gcode,"m30",1);
}

</script>

<canvas id="mycanvas"> </canvas>

</body>
</html>
